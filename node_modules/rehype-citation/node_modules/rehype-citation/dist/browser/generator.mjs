import{visit as e}from"unist-util-visit";import t from"cross-fetch";import{fromDom as r}from"hast-util-from-dom";const n=/\[([^[\]]*@[^[\]]+)\]|(?!\b)(@[a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\-+?<>~]*)/,o=/@([a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\-+?<>~]*)/,i=/\[.*\]/,a={book:"book","bk.":"book","bks.":"book",chapter:"chapter","chap.":"chapter","chaps.":"chapter",column:"column","col.":"column","cols.":"column",figure:"figure","fig.":"figure","figs.":"figure",folio:"folio","fol.":"folio","fols.":"folio",number:"number","no.":"number","nos.":"number",line:"line","l.":"line","ll.":"line",note:"note","n.":"note","nn.":"note",opus:"opus","op.":"opus","opp.":"opus",page:"page","p.":"page","pp.":"page",paragraph:"paragraph","para.":"paragraph","paras.":"paragraph",part:"part","pt.":"part","pts.":"part",section:"section","sec.":"section","secs.":"section","sub verbo":"sub verbo","s.v.":"sub verbo","s.vv.":"sub verbo",verse:"verse","v.":"verse","vv.":"verse",volume:"volume","vol.":"volume","vols.":"volume","¶":"paragraph","¶¶":"paragraph","§":"section","§§":"section"},l=e=>{let t;try{t=new URL(e)}catch(e){return!1}return"http:"===t.protocol||"https:"===t.protocol},s=e=>{const t=document.createRange().createContextualFragment(e);return r(t).children[0]},p=["div","p","span","li"],c=r=>(c={})=>async(u,h)=>{var d,m;let f,g=await(async(e,t)=>{var r,n;let o="";if(e.bibliography)o=e.bibliography;else if(null!=t&&null!=(r=t.data)&&null!=(n=r.frontmatter)&&n.bibliography&&(o=t.data.frontmatter.bibliography,!l(o)))throw new Error("Cannot read non valid bibliography URL in node env.");return o})(c,h);if(!g)return;const b=c.csl||(null==h||null==(d=h.data)||null==(m=d.frontmatter)?void 0:m.csl)||"apa";if(!l(g))throw new Error("Cannot read non valid bibliography URL in node env.");{const e=await t(g);f=await e.text()}const v=new r(f),y=v.data.map(e=>e.id),x=[];let w=1;const k=r.plugins.config.get("@csl").engine(v.data,b,c.lang||"en-US","html");if(e(u,"text",(e,t,r)=>{const l=e.value.match(n);if(!l||!p.includes(r.tagName))return;const c=l.index,u=l.index+l[0].length,h=[];0!==c&&h.push({type:"text",value:e.value.slice(0,c)});const[d,m]=(e=>{let t,r=[];if(i.test(e)){t={noteIndex:0};const n=e.substr(1,e.length-2).split(";");for(const e of n){let t="",n="",i="page",l="";const s=e.split("@");if(1===s.length)throw new Error("Cite key should be in the form of @key");if(s.length>2)throw new Error("More than one cite key @ detected, please separate keys with ;");t+=s[0],t=t.trim();let p=e.indexOf("@")>0&&"-"===e[e.indexOf("@")-1];p&&(t=t.substr(0,t.length-1).trim());let c=s[1].indexOf(",")+1;0===c&&(c=s[1].indexOf(" ")+1),c<=0&&(c=void 0);const u=e.substr(e.indexOf("@"),c).match(o)[0];let h=e.split("@")[1].substr(u.length).trim();","===h[0]&&(h=h.substr(1).trim());const d=h.match(/(\d|-| |,)+/g);null!==d?(n=d[0].trim(),i=h.split(n)[0].trim(),i=a[i]||"page",l=h.split(n)[1].trim()):l=h.trim(),r.push({id:e.match(o)[1],locator:n,label:i,prefix:t,suffix:l,"suppress-author":p})}}else t={noteIndex:0,mode:"composite"},r=[e].map(e=>({id:e.match(o)[1]}));return[t,r]})(l[0]);for(const e of m)if(!y.includes(e.id))return;const f=((e,t,r,n,o={noteIndex:0})=>{const i=e.processCitationCluster({citationID:r,citationItems:t,properties:o},n.length>0?n:[],[])[1].filter(e=>e[2]===r);return s(`<div>${i[0][1]}</div>`).children[0]})(k,m,`CITATION-${w}`,x,d);x.push([`CITATION-${w}`,0]),w+=1,h.push(f),u<e.value.length&&h.push({type:"text",value:e.value.slice(u)}),r.children=[...r.children.slice(0,t),...h,...r.children.slice(t+1)]}),c.noCite&&k.updateItems(c.noCite.map(e=>e.replace("@",""))),!c.suppressBibliography&&k.registry.mylist.length>=1){const t=(e=>{const[,t]=e.makeBibliography(),r='<div id="refs" class="references csl-bib-body">\n'+t.join("")+"</div>";return s(r)})(k);let r=!1;e(u,"element",(e,n,o)=>{"p"!==e.tagName&&"div"!==e.tagName||"[^ref]"!==e.children[0].value||(o.children[n]=t,r=!0)}),r||u.children.push(t)}};export{c as default};
//# sourceMappingURL=generator.mjs.map
