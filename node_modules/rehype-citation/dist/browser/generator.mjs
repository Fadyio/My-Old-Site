import{visit as e}from"unist-util-visit";import t from"cross-fetch";import{fromDom as n}from"hast-util-from-dom";function r(){return r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},r.apply(this,arguments)}const i=/\[([^[\]]*@[^[\]]+)\]|(?!\b)(@[a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\-+?<>~]*)/,o=/@([a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\-+?<>~]*)/,s=/\[.*\]/,a={book:"book","bk.":"book","bks.":"book",chapter:"chapter","chap.":"chapter","chaps.":"chapter",column:"column","col.":"column","cols.":"column",figure:"figure","fig.":"figure","figs.":"figure",folio:"folio","fol.":"folio","fols.":"folio",number:"number","no.":"number","nos.":"number",line:"line","l.":"line","ll.":"line",note:"note","n.":"note","nn.":"note",opus:"opus","op.":"opus","opp.":"opus",page:"page","p.":"page","pp.":"page",paragraph:"paragraph","para.":"paragraph","paras.":"paragraph",part:"part","pt.":"part","pts.":"part",section:"section","sec.":"section","secs.":"section","sub verbo":"sub verbo","s.v.":"sub verbo","s.vv.":"sub verbo",verse:"verse","v.":"verse","vv.":"verse",volume:"volume","vol.":"volume","vols.":"volume","¶":"paragraph","¶¶":"paragraph","§":"section","§§":"section"},l=async e=>{if(p(e))return t(e).then(e=>e.text()).then(e=>e);throw new Error("Cannot read non valid URL in node env.")},p=e=>{let t;try{t=new URL(e)}catch(e){return!1}return"http:"===t.protocol||"https:"===t.protocol},c=e=>{const t=document.createRange().createContextualFragment(e);return n(t).children[0]},u=["div","p","span","li"],h=n=>(h={})=>async(d,f)=>{var m,g,b;let v,y=await(async(e,t)=>{var n,r;let i="";if(e.bibliography)i=e.bibliography;else if(null!=t&&null!=(n=t.data)&&null!=(r=n.frontmatter)&&r.bibliography&&(i=t.data.frontmatter.bibliography,!p(i)))throw new Error("Cannot read non valid bibliography URL in node env.");return i})(h,f);if(!y)return;const w=h.csl||(null==f||null==(m=f.data)||null==(g=m.frontmatter)?void 0:g.csl)||"apa",x=h.lang||"en-US",C=n.plugins.config.get("@csl"),k=await(async(e,t,n="")=>{const r=e.plugins.config.get("@csl");if(Object.keys(r.templates.data).includes(t))return t;{let e="";p(t)&&(e=t);try{r.templates.add("customCSL",await l(e))}catch(e){throw new Error(`Input CSL option, ${t}, is invalid or is an unknown file.`)}return"customCSL"}})(n,w,h.path),$=await(async(e,t,n="")=>{const r=e.plugins.config.get("@csl");if(Object.keys(r.locales.data).includes(t))return t;{let e="";p(t)&&(e=t);try{const t=await l(e),n=t.match(/xml:lang="(.+)"/)[1];return r.locales.add(n,t),n}catch(e){throw new Error(`Input locale option, ${t}, is invalid or is an unknown file.`)}}})(n,x,h.path);if(!p(y))throw new Error("Cannot read non valid bibliography URL in node env.");{const e=await t(y);v=await e.text()}const I=new n(v),O=I.data.map(e=>e.id),j=[];let E=1;const L=C.engine(I.data,k,$,"html");if(e(d,"text",(e,t,n)=>{const r=e.value.match(i);if(!r||!u.includes(n.tagName))return;const l=r.index,p=r.index+r[0].length,d=[];0!==l&&d.push({type:"text",value:e.value.slice(0,l)});const[f,m]=(e=>{let t,n=[];if(s.test(e)){t={noteIndex:0};const r=e.substr(1,e.length-2).split(";");for(const e of r){let t="",r="",i="page",s="";const l=e.split("@");if(1===l.length)throw new Error("Cite key should be in the form of @key");if(l.length>2)throw new Error("More than one cite key @ detected, please separate keys with ;");t+=l[0],t=t.trim();let p=e.indexOf("@")>0&&"-"===e[e.indexOf("@")-1];p&&(t=t.substr(0,t.length-1).trim());let c=l[1].indexOf(",")+1;0===c&&(c=l[1].indexOf(" ")+1),c<=0&&(c=void 0);const u=e.substr(e.indexOf("@"),c).match(o)[0];let h=e.split("@")[1].substr(u.length).trim();","===h[0]&&(h=h.substr(1).trim());const d=h.match(/(\d|-| |,)+/g);null!==d?(r=d[0].trim(),i=h.split(r)[0].trim(),i=a[i]||"page",s=h.split(r)[1].trim()):s=h.trim(),n.push({id:e.match(o)[1],locator:r,label:i,prefix:t,suffix:s,"suppress-author":p})}}else t={noteIndex:0,mode:"composite"},n=[e].map(e=>({id:e.match(o)[1]}));return[t,n]})(r[0]);for(const e of m)if(!O.includes(e.id))return;const g=((e,t,n,r,i,o={noteIndex:0})=>{var s;const a=e.processCitationCluster({citationID:n,citationItems:t,properties:o},r.length>0?r:[],[])[1].find(e=>e[2]===n),l=`citation--${t.map(e=>e.id.toLowerCase()).join("--")}--${n.split("-")[1]}`;return c(`<span class="${(null!=(s=i.inlineClass)?s:[]).join(" ")}" id=${l}>${a[1]}</span>`)})(L,m,`CITATION-${E}`,j,h,f);j.push([`CITATION-${E}`,0]),E+=1,d.push(g),p<e.value.length&&d.push({type:"text",value:e.value.slice(p)}),n.children=[...n.children.slice(0,t),...d,...n.children.slice(t+1)]}),h.noCite&&L.updateItems(h.noCite.map(e=>e.replace("@",""))),L.registry.mylist.length>=1&&(!h.suppressBibliography||(null==(b=h.inlineBibClass)?void 0:b.length)>0)){const t=(e=>{const[t,n]=e.makeBibliography(),r='<div id="refs" class="references csl-bib-body">\n'+n.join("")+"</div>",i=c(r);return i.children.filter(e=>{var t,n;return null==(t=e.properties)||null==(n=t.className)?void 0:n.includes("csl-entry")}).forEach((e,n)=>{const r=t.entry_ids[n][0].toLowerCase();e.properties=e.properties||{},e.properties.id="bib-"+r}),i})(L);let n=!1;const i={};t.children.filter(e=>{var t,n;return null==(t=e.properties)||null==(n=t.className)?void 0:n.includes("csl-entry")}).forEach(e=>{const t=e.properties.id.split("-").slice(1).join("-");i[t]=r({},e),i[t].properties={id:"inlinebib-"+t}}),e(d,"element",(e,r,o)=>{var s,a,l;if((null==(s=h.inlineBibClass)?void 0:s.length)>0&&null!=(a=e.properties)&&null!=(l=a.id)&&l.toString().startsWith("citation-")){const[,...t]=e.properties.id.toString().split("--"),n=t.pop(),r={type:"element",tagName:"div",properties:{className:h.inlineBibClass,id:`inlineBib--${t.join("--")}--${n}`},children:t.map(e=>{const t=i[e];return t.properties={class:"inline-entry",id:`inline--${e}--${n}`},t})};o.children.push(r)}h.suppressBibliography||"p"!==e.tagName&&"div"!==e.tagName||"[^ref]"!==e.children[0].value||(o.children[r]=t,n=!0)}),h.suppressBibliography||n||d.children.push(t)}};export{h as default};
//# sourceMappingURL=generator.mjs.map
